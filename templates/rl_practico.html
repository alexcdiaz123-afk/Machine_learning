<!-- rl_case.html -->
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>RL — Caso práctico</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 16px; }
    .controls { margin-bottom: 12px; }
    .controls label { margin-right: 8px; }
    .plots { display:flex; gap:16px; margin-top:12px; flex-wrap:wrap; }
    .plots img { max-width:420px; border:1px solid #ccc; }
    .indicators p { margin:6px 0; }
  </style>
</head>
<body>
  <h2>Caso práctico — GridWorld (Q-Learning)</h2>

  <div class="controls">
    <label>Episodios: <input id="episodes" type="number" value="1000" min="1"></label>
    <label>α: <input id="alpha" type="number" step="0.01" value="0.1"></label>
    <label>γ: <input id="gamma" type="number" step="0.01" value="0.99"></label>
    <label>ε: <input id="epsilon" type="number" step="0.01" value="0.3"></label>
    <label>Grid size: <input id="size" type="number" value="5" min="3" max="12"></label>
    <button id="trainBtn">Entrenar</button>
    <button id="simulateBtn">Simular política</button>
  </div>

  <div class="indicators">
    <p>Estado: <span id="status">—</span></p>
    <p>Tiempo entrenamiento: <span id="elapsed">—</span></p>
    <p>Recompensa promedio (últimos 100): <span id="avg_reward">—</span></p>
  </div>

  <div class="plots">
    <div>
      <h4>Evolución recompensa</h4>
      <img id="rewardPlot" src="" alt="Recompensa" />
    </div>
    <div>
      <h4>Trayectoria greedy</h4>
      <img id="trajPlot" src="" alt="Trayectoria" />
    </div>
  </div>

  <script>
    const trainBtn = document.getElementById('trainBtn');
    const simulateBtn = document.getElementById('simulateBtn');
    const statusSpan = document.getElementById('status');
    const elapsedSpan = document.getElementById('elapsed');
    const avgRewardSpan = document.getElementById('avg_reward');
    const rewardPlot = document.getElementById('rewardPlot');
    const trajPlot = document.getElementById('trajPlot');

    trainBtn.addEventListener('click', async () => {
      const payload = {
        episodes: parseInt(document.getElementById('episodes').value),
        alpha: parseFloat(document.getElementById('alpha').value),
        gamma: parseFloat(document.getElementById('gamma').value),
        epsilon: parseFloat(document.getElementById('epsilon').value),
        size: parseInt(document.getElementById('size').value)
      };
      statusSpan.textContent = 'Entrenando... (petición en curso)';
      rewardPlot.src = '';
      trajPlot.src = '';
      try {
        const resp = await fetch('/train', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        if (data.status === 'ok') {
          statusSpan.textContent = 'Entrenamiento completado';
          elapsedSpan.textContent = data.results.elapsed_seconds.toFixed(2) + ' s';
          avgRewardSpan.textContent = data.results.avg_reward_last_100;
          rewardPlot.src = 'data:image/png;base64,' + data.reward_plot;
          trajPlot.src = 'data:image/png;base64,' + data.trajectory_plot;
        } else {
          statusSpan.textContent = 'Error: ' + (data.message || 'Desconocido');
        }
      } catch (err) {
        console.error(err);
        statusSpan.textContent = 'Error de red o servidor';
      }
    });

    simulateBtn.addEventListener('click', async () => {
      statusSpan.textContent = 'Simulando política...';
      try {
        const resp = await fetch('/simulate');
        const data = await resp.json();
        if (data.status === 'ok') {
          statusSpan.textContent = 'Simulación completada. Recompensa total: ' + data.total_reward.toFixed(2);
          trajPlot.src = 'data:image/png;base64,' + data.trajectory_plot;
        } else {
          statusSpan.textContent = 'Error: ' + (data.message || 'Desconocido');
        }
      } catch (err) {
        console.error(err);
        statusSpan.textContent = 'Error en simulación';
      }
    });
  </script>
</body>
</html>
